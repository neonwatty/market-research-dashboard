name: Research seating-arrangement

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9am UTC
  workflow_dispatch:

env:
  TARGET_REPO: neonwatty/seating-arrangement
  REPO_NAME: seating-arrangement

jobs:
  research:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install reddit-market-research
        run: pip install reddit-market-research

      - name: Create praw.ini
        run: |
          cat > praw.ini << 'EOF'
          [market_research]
          client_id=${{ secrets.REDDIT_CLIENT_ID }}
          client_secret=${{ secrets.REDDIT_CLIENT_SECRET }}
          username=${{ secrets.REDDIT_USERNAME }}
          password=${{ secrets.REDDIT_PASSWORD }}
          user_agent=market_research_bot
          EOF

      - name: Run Claude Market Research
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            1. Fetch and read the README from ${{ env.TARGET_REPO }} to understand the project
            2. Check findings/${{ env.REPO_NAME }}/ for the last 3 days of scans to avoid duplicating posts
            3. Generate relevant keywords and subreddits for market research
            4. Run: reddit-market-research search -s "<subreddits>" -k "<keywords>" --json
            5. Create a markdown file at findings/${{ env.REPO_NAME }}/$(date +%Y-%m-%d).md with:
               - One-line project summary
               - Key Takeaways section FIRST (3-5 bullet points based on the posts found)
               - Table of Reddit posts ranked by RELEVANCE to the project (not by upvotes): title, subreddit, score, comments, link, and a brief summary
               - Exclude any posts that appeared in the last 3 days of findings
            6. Git commit and push the new file
          claude_args: "--allowedTools 'Bash(reddit-market-research:*),Bash(git:*),Bash(curl:*),Read,Write'"
